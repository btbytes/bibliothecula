{% extends "base.html" %}
{% block title %}{{document}}{% endblock %}
{% block style %}
    <style>
        .Squire-UI .menu,
        .Squire-UI .menu .group {
            display: flex;
            column-gap: 5px;
            height: min-content;
            flex-direction: row;
            flex-wrap: wrap;
            row-gap: 2px;
        }

        .Squire-UI .menu {
            width: 100%;
            justify-content: left;
            border-bottom: 1px solid #888;
            padding: 4px;
        }

        .Squire-UI .menu .group {
            width: max-content;
            margin: 0;
        }

        iframe {
            width: 100%;
            height: 100%;
            padding: 7px 8px;
            color: #333;
            background-color: #fff;
            background-repeat: no-repeat;
            background-position: right center;
            border: 0;
            box-shadow: none;
            outline: none;
        }

        div.iframe {
            resize: vertical;
            overflow: hidden;
            width: 65ch;
            min-height: 20rem;
            min-width: 32ch;
            max-width: 100%;
            display: none;
            flex-direction: column;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.075);
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .menu .item {
            color: #000;
            float: left;
            background: #FFF;
            border-left: 1px #EEE solid;
            border-bottom: 3px transparent solid;
            height: 22px;
            width: 22px;
            text-align: center;
        }

        .menu .item>* {
            vertical-align: sub;
        }

        .menu .item img, .menu .item svg {
            image-rendering: crisp-edges;
            height: 22px;
            width: 22px;
        }

        .menu .group {
            border-radius: 3px;
            display: inline-block;
            border: 1px #EEE solid;
            margin: 5px
        }

        .menu .group .item .flip {
            -ms-transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
            -moz-transform: rotateY(180deg);

            tr div.help::after {
                content: attr(data-help-text);
                width: max-content;
                margin-top: calc(1.5rem/2);
                position: absolute;
                right: 1rem;
                color: gray;
            }

            div.help {
                position: relative;
                width: 0;
            }

            input:placeholder-shown+div.help {
                display: none;
            }

            .uuid-header {
                display: inline-block;
                border: 1px solid black;
                border-radius: 2px;
                font-size: 50%;
                padding: .1rem .5rem;
                background: var(--blue-color);
                color: #fff;
                font-weight: initial;
                font-family: monospace;
                user-select: all;
                margin: 0 1rem;
                vertical-align: middle;
            }
            </style>
            <script src="/static/Squire-UI.js" type="text/javascript"></script>
            <script>
                var ready = (callback) => {
                    if (document.readyState != "loading") callback();
                    else document.addEventListener("DOMContentLoaded", callback);
                }

                var div = null;
                ready(() => {
                    div = new SquireUI({
                        replace: 'textarea#id_content',
                        height: 300
                    });
                });
            </script>
{% endblock %}
{% block content %}
    <h1>{% if metadata %}Edit{{metadata.filename }}{% else %}Create text file{% endif %} - {{ document.title }}<span class="uuid-header">{{ document.uuid }}</span></h1>
    <form method="post">
        {% csrf_token %}
        <fieldset>
            <legend>new text file</legend>
            {% for field in form %}
                {{ field.errors }}
                {{ field.label_tag }}
                {% if field.help_text %}
                    <div style="display: flex;flex-direction: row;">
                        {{ field }}
                        <div class="help" data-help-text="{{ field.help_text|safe }}"></div>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
            {% endfor %}
            <div class="iframe"><iframe id="squire-iframe" src="/static/squire.html" /> </iframe></div>
        <input type="submit" value="save">
    </fieldset>
    </form>
    <datalist id="{{ form.datalist_id }}">
        {% for opt in form.datalist_options %}
            <option value="{{ opt }}">
        {% endfor %}
    </datalist>
    <script type="text/javascript" src="/static/squire.js"></script>
    <script id="content-html" type="text/html">{{ content_html }}</script>
    <script>
        var squire_iframe = null;
        var editor_object = null;
        squire_iframe = document.querySelector('#squire-iframe');

        squire_iframe.addEventListener('load', (event) => {
            squire_iframe = document.querySelector('#squire-iframe');
            var inner_w = squire_iframe;
            var editor = inner_w.contentWindow.editor;

            Squire.prototype.makeHeader = function() {
                return this.modifyBlocks(function(frag) {
                    var output = this._doc.createDocumentFragment();
                    var block = frag;
                    while (block = Squire.getNextBlock(block)) {
                        output.appendChild(
                            this.createElement('h2', [Squire.empty(block)])
                        );
                    }
                    return output;
                });
            };
            Squire.prototype.testPresenceinSelection = function(name, action, format,
                validation) {
                    var path = this.getPath(),
                    test = (validation.test(path) | this.hasFormat(format));
                    if (name == action && test) {
                        return true;
                    } else {
                        return false;
                    }
                };

            editor.setHTML(document.getElementById("content-html").text);
            return editor;
        });
    </script>
{% endblock %}

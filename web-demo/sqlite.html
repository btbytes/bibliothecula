<meta charset="utf8" />
<html>
<style>
html, body, main{
width: 100%;
height: 100%;
}
      body {
        display: flex;
      }

      table,
td {
    border: 1px solid #333;
}

caption {
 overflow: auto;
 height: 3rem;
}

caption code {
  user-select: all;
}

thead {
  position: sticky;
  top: 0;
}
thead,
tfoot {
    background-color: #333;
    color: #fff;
}

main {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  grid-template-rows: 1fr auto;
  row-gap: 1rem;
  height: min-content;
  place-self: center;
  align-self: auto;
}

  div#results {
    place-self: center;grid-column: 2 / span 10;grid-row: 2/span 1;
  }
  div#tables {
    overflow: auto;
    height: 17rem;
    width: 66ch;
    place-self: center;
    grid-column: 2 / span 2;
    grid-row: 1/span 1;
  }
  .input {
 grid-row: 1 /span 1;
 grid-column: 2/span 10;
 place-self: center;
}


</style>
<script id="data" type="application/json">
  {}
</script>

  <script src='./sql-wasm.js'></script>
  <script>
    function getSchema(db){
    var request = new XMLHttpRequest();
    request.open('GET', './schema.sql', true);
    request.send(null);
    request.onreadystatechange = function () {
        if (request.readyState === 4 && request.status === 200) {
            var type = request.getResponseHeader('Content-Type');
            if (type.indexOf("text") !== 1) {
              //console.log(request.responseText);
              db.run(request.responseText);
              console.dir(db);
                return request.responseText;
            }
        }
    }
}

var tableCreate = function () {
	function valconcat(huh, tagName) {
		if (huh.length === 0) return '';
		var open = '<' + tagName + '>', close = '</' + tagName + '>';
		return open + huh.join(close + open) + close;
	}
	return function (sql, columns, values) {
		var tbl = document.createElement('table');
    var html = '<caption><code>'+sql+'</code>  ' + values.length + ' rows</caption>';
		html += '<thead>' + valconcat(columns, 'th') + '</thead>';
		var rows = values.map(function (v) { return valconcat(v, 'td'); });
		html += '<tbody>' + valconcat(rows, 'tr') + '</tbody>';
		tbl.innerHTML = html;
		return tbl;
	}
}();


var jsonData = JSON.parse(document.getElementById('data').textContent)
var db = null;

    config = {
      locateFile: filename => `./${filename}`
    }
    // The `initSqlJs` function is globally provided by all of the main dist files if loaded in the browser.
    // We must specify this locateFile function if we are loading a wasm file from anywhere other than the current html page's folder.
    initSqlJs(config).then(function(SQL){
      //Create the database
      db = new SQL.Database();
      var request = new XMLHttpRequest();
      request.open('GET', './schema.sql', true);
      request.send(null);
      request.onreadystatechange = function () {
        if (request.readyState === 4 && request.status === 200) {
          var type = request.getResponseHeader('Content-Type');
          if (type.indexOf("text") !== 1) {
            //console.log(request.responseText);
            db.run(request.responseText);
            console.dir(db);
            var requestData = new XMLHttpRequest();
            requestData.open('GET', './data.json', true);
            requestData.send(null);
            requestData.onreadystatechange = function () {
              if (requestData.readyState === 4 && requestData.status === 200) {
                var type = requestData.getResponseHeader('Content-Type');
                if (type.indexOf("text") !== 1) {
                  data = JSON.parse(requestData.responseText);
                  //{"documents":[],"tags":[],"files":[],"has_text":[],"has_b":[]}
                  stmt = "INSERT INTO Documents (uuid, title, created, last_modified) VALUES ";
                  stmt += data.documents.map(doc => {
                    return "('"+[doc.uuid, doc.title, doc.created, doc.last_modified].join("','")+"')";
                  }).join(", ");
                  db.run(stmt);
                  stmt = "INSERT OR IGNORE INTO TextMetadata (uuid, name, data, created, last_modified) VALUES ";
                  stmt += data.tags.map(t => {
                    return "('"+[t.uuid, t.name, t.data, t.created, t.last_modified].join("','")+"')";
                  }).join(", ");
                  db.run(stmt);
                  stmt = "INSERT OR IGNORE INTO BinaryMetadata (uuid, name, data, created, last_modified) VALUES ";
                  stmt += data.files.map(t => {
                    return "('"+[t.uuid, t.name, t.data, t.created, t.last_modified].join("','")+"')";
                  }).join(", ");
                  db.run(stmt);
                  stmt = "INSERT OR IGNORE INTO DocumentHasTextMetadata (id, name, document_uuid, metadata_uuid, created, last_modified) VALUES ";
                  stmt += data.has_text.map(t => {
                    return "('"+[t.id, t.name, t.document_uuid, t.metadata_uuid, t.created, t.last_modified].join("','")+"')";
                  }).join(", ");
                  db.run(stmt);
                  stmt = "INSERT OR IGNORE INTO DocumentHasBinaryMetadata (id, name, document_uuid, metadata_uuid, created, last_modified) VALUES ";
                  stmt += data.has_b.map(t => {
                    return "('"+[t.id, t.name, t.document_uuid, t.metadata_uuid, t.created, t.last_modified].join("','")+"')";
                  }).join(", ");
                  db.run(stmt);
                  var tbl_query = "select name as table_name, sql from sqlite_schema where type = 'table'";
                  var [columns, values] = run_query(db, tbl_query);
                  var counts = values.map(table => {
                    try {
                      stmt = "select count(*) as count from "+table[0];
                      var [columns, values] = run_query(db, stmt);
                    return values[0];
                    } catch {
                      return 0;
                    }
                  });
                  columns.push("count");
                  var i = 0;
                  var values = values.map(table => {
                    table.push(counts[i]);
                    i+=1;
                    return table;
                  });

                  tables.appendChild(tableCreate(tbl_query, columns, values));

                  return;
                }
              }
            }
            return request.responseText;
          }
        }
      }

      // Run a query without reading the results
      //db.run("CREATE TABLE test (col1, col2);");
      // Insert two rows: (1,111) and (2,222)
      //db.run("INSERT INTO test VALUES (?,?), (?,?)", [1,111,2,222]);

      // Prepare a statement
      //var stmt = db.prepare("SELECT * FROM test WHERE col1 BETWEEN $start AND $end");
      //stmt.getAsObject({$start:1, $end:1}); // {col1:1, col2:111}

      // Bind new values
      //stmt.bind({$start:1, $end:2});
      //while(stmt.step()) { //
        //var row = stmt.getAsObject();
        //console.log('Here is a row: ' + JSON.stringify(row));
      //}
    });

if (document.readyState === 'loading') {  // Loading hasn't finished yet
  document.addEventListener('DOMContentLoaded', add_listeners);
} else {  // `DOMContentLoaded` has already fired
  add_listeners();
}

function run_query(db, stmt) {
  var stmt = db.prepare(stmt);
  var columns = null;
  var values = Array();
  while(stmt.step()) { //
      var row = stmt.getAsObject();
      values.push(Object.values(row));
      columns = Object.keys(row);
  }
  stmt.free();
  return [columns, values];
}

function add_listeners() {
const button = document.querySelector('#submit');
const tables = document.querySelector('#tables');
const input = document.querySelector('#input');
const results = document.querySelector('#results');
button.addEventListener('click', event => {
  let table = document.createElement("table");
  let tbody = document.createElement("tbody");
  //table.appendChild(tbody);

  results.innerHTML = "";
  //results.appendChild(table);
  var sql = input.value;
  try {
    var [columns, values] = run_query(db, sql);
    console.dir(columns);
    console.dir(values);

        //let tr = document.createElement("tr");
        //let td = document.createElement("td");
        //let inner = document.createTextNode(JSON.stringify(row));
        //td.appendChild(inner);
        //tr.appendChild(td);
        //tbody.appendChild(tr);
        results.appendChild(tableCreate(sql, columns, values));
  } catch (error) {
    console.error(error);
        let p = document.createElement("p");
        p.style.color = "red";
        let inner = document.createTextNode(error.toString());
        p.appendChild(inner);
        results.appendChild(p);
  }
});
}
  </script>
  <body>
    <main>
      <div id="tables" style=""></div>
        <div class="input">
          <textarea id="input" type="text" placeholder="sql query" rows=5 cols="80" >select d.*,  group_concat(m.data) as tags from TextMetadata as m, DocumentHasTextMetadata as has, Documents as d where has.document_uuid = d.uuid and has.metadata_uuid = m.uuid and has.name = 'tag' group by d.uuid;</textarea>
    <button id="submit" type="button" />submit</button>
        </div>
      <div id="results" style="">Results</div>
      </div>
    </main>
  </body>
</html>
